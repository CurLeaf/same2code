<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç±»ç›®åˆ†ç±»æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .card h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        .card h2 .emoji {
            margin-right: 8px;
        }
        .status-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            font-size: 14px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        .status-dot.online { background: #4caf50; }
        .status-dot.offline { background: #f44336; }
        .status-dot.loading { background: #ff9800; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%);
            color: white;
        }
        .input-group {
            margin-bottom: 16px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .input-row {
            display: flex;
            gap: 16px;
        }
        .input-row .input-group {
            flex: 1;
        }
        .input-row .input-group.small {
            flex: 0 0 120px;
        }
        .result-box {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result-box pre {
            color: #d4d4d4;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 0;
        }
        .result-box .success { color: #4caf50; }
        .result-box .error { color: #f44336; }
        .result-box .info { color: #2196f3; }
        .result-item {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .result-item:last-child {
            margin-bottom: 0;
        }
        .result-item .score {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .result-item .id {
            color: #9cdcfe;
            font-family: monospace;
            font-size: 13px;
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .hidden { display: none; }
        .tip {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #856404;
            font-size: 14px;
        }
        .tip strong {
            color: #664d03;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ·ï¸ å•†å“ç±»ç›®åˆ†ç±»æµ‹è¯•</h1>

        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <h2><span class="emoji">ğŸ“Š</span>æœåŠ¡çŠ¶æ€</h2>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="serverStatus"></div>
                    <span>æœåŠ¡: <strong id="serverStatusText">æ£€æµ‹ä¸­...</strong></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="indexStatus"></div>
                    <span>ç´¢å¼•: <strong id="indexStatusText">æ£€æµ‹ä¸­...</strong></span>
                </div>
                <button class="btn btn-primary" onclick="checkHealth()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>

        <!-- ç´¢å¼•ç®¡ç† -->
        <div class="card">
            <h2><span class="emoji">ğŸ—‚ï¸</span>ç´¢å¼•ç®¡ç†</h2>
            <div class="tip">
                <strong>æç¤ºï¼š</strong>é¦–æ¬¡ä½¿ç”¨éœ€è¦æ„å»ºç´¢å¼•ï¼Œçº¦ 11764 æ¡ç±»ç›®ï¼Œé¢„è®¡éœ€è¦å‡ åˆ†é’Ÿã€‚æ„å»ºå®Œæˆåä¼šè‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡åªéœ€åŠ è½½å³å¯ã€‚
            </div>
            <div class="btn-group">
                <button class="btn btn-success" id="btnBuild" onclick="buildIndex()">
                    ğŸ”¨ æ„å»ºç´¢å¼•
                </button>
                <button class="btn btn-primary" id="btnLoad" onclick="loadIndex()">
                    ğŸ“‚ åŠ è½½ç´¢å¼•
                </button>
                <button class="btn btn-danger" id="btnDelete" onclick="deleteIndex()">
                    ğŸ—‘ï¸ åˆ é™¤ç´¢å¼•
                </button>
            </div>
            <div class="result-box" id="indexResult">
                <pre class="info">ç­‰å¾…æ“ä½œ...</pre>
            </div>
        </div>

        <!-- ç±»ç›®æŸ¥è¯¢ -->
        <div class="card">
            <h2><span class="emoji">ğŸ”</span>ç±»ç›®æŸ¥è¯¢</h2>
            <div class="input-row">
                <div class="input-group">
                    <label>å•†å“æ–‡æœ¬</label>
                    <textarea id="queryText" placeholder="è¾“å…¥å•†å“æ ‡é¢˜æˆ–æè¿°ï¼Œä¾‹å¦‚ï¼šçŒ«ç²® çš‡å®¶ æˆçŒ« 10kg"></textarea>
                </div>
                <div class="input-group small">
                    <label>è¿”å›æ•°é‡ (K)</label>
                    <input type="number" id="queryK" value="5" min="1" max="20">
                </div>
            </div>
            <button class="btn btn-primary" id="btnQuery" onclick="queryCategory()">
                ğŸš€ æŸ¥è¯¢ç±»ç›®
            </button>
            <div class="result-box" id="queryResult">
                <pre class="info">è¾“å…¥å•†å“æ–‡æœ¬åç‚¹å‡»æŸ¥è¯¢</pre>
            </div>
        </div>

        <!-- å¿«é€Ÿæµ‹è¯• -->
        <div class="card">
            <h2><span class="emoji">âš¡</span>å¿«é€Ÿæµ‹è¯•</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="quickTest('iPhone 15 Pro Max 256GB é’›é‡‘å±')">ğŸ“± æ‰‹æœº</button>
                <button class="btn btn-primary" onclick="quickTest('çŒ«ç²® çš‡å®¶ æˆçŒ« å®¤å†…çŒ« 10kg')">ğŸ± çŒ«ç²®</button>
                <button class="btn btn-primary" onclick="quickTest('Nike Air Jordan 1 è¿åŠ¨é‹ ç”·æ¬¾')">ğŸ‘Ÿ è¿åŠ¨é‹</button>
                <button class="btn btn-primary" onclick="quickTest('é›…è¯—å…°é»›å°æ£•ç“¶ç²¾åæ¶² 50ml')">ğŸ’„ æŠ¤è‚¤å“</button>
                <button class="btn btn-primary" onclick="quickTest('ä¹é«˜ç§¯æœ¨ å“ˆåˆ©æ³¢ç‰¹åŸå ¡ æ‹¼è£…ç©å…·')">ğŸ§± ç©å…·</button>
                <button class="btn btn-primary" onclick="quickTest('æˆ´æ£®V15å¸å°˜å™¨ æ— çº¿æ‰‹æŒ')">ğŸ”Œ å®¶ç”µ</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';  // åŒæºï¼Œæ— éœ€é…ç½®

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.onload = () => {
            checkHealth();
        };

        // å¥åº·æ£€æŸ¥
        async function checkHealth() {
            const serverDot = document.getElementById('serverStatus');
            const serverText = document.getElementById('serverStatusText');
            const indexDot = document.getElementById('indexStatus');
            const indexText = document.getElementById('indexStatusText');

            serverDot.className = 'status-dot loading';
            serverText.textContent = 'æ£€æµ‹ä¸­...';

            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();

                serverDot.className = 'status-dot online';
                serverText.textContent = 'åœ¨çº¿';

                if (data.indexLoaded) {
                    indexDot.className = 'status-dot online';
                    indexText.textContent = 'å·²åŠ è½½';
                } else {
                    indexDot.className = 'status-dot offline';
                    indexText.textContent = 'æœªåŠ è½½';
                }
            } catch (e) {
                serverDot.className = 'status-dot offline';
                serverText.textContent = 'ç¦»çº¿';
                indexDot.className = 'status-dot offline';
                indexText.textContent = 'æœªçŸ¥';
            }
        }

        // æ„å»ºç´¢å¼•
        async function buildIndex() {
            const btn = document.getElementById('btnBuild');
            const result = document.getElementById('indexResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>æ„å»ºä¸­...';
            result.innerHTML = '<pre class="info">æ­£åœ¨æ„å»ºç´¢å¼•ï¼Œè¯·ç¨å€™ï¼ˆçº¦éœ€å‡ åˆ†é’Ÿï¼‰...</pre>';

            try {
                const res = await fetch(`${API_BASE}/category/index`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    result.innerHTML = '<pre class="success">âœ… ' + data.message + '</pre>';
                } else {
                    result.innerHTML = '<pre class="error">âŒ ' + data.error + '</pre>';
                }
            } catch (e) {
                result.innerHTML = '<pre class="error">âŒ è¯·æ±‚å¤±è´¥: ' + e.message + '</pre>';
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ”¨ æ„å»ºç´¢å¼•';
            checkHealth();
        }

        // åŠ è½½ç´¢å¼•
        async function loadIndex() {
            const btn = document.getElementById('btnLoad');
            const result = document.getElementById('indexResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>åŠ è½½ä¸­...';

            try {
                const res = await fetch(`${API_BASE}/category/load`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    result.innerHTML = '<pre class="success">âœ… ' + data.message + '</pre>';
                } else {
                    result.innerHTML = '<pre class="error">âŒ ' + data.error + '</pre>';
                }
            } catch (e) {
                result.innerHTML = '<pre class="error">âŒ è¯·æ±‚å¤±è´¥: ' + e.message + '</pre>';
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ“‚ åŠ è½½ç´¢å¼•';
            checkHealth();
        }

        // åˆ é™¤ç´¢å¼•
        async function deleteIndex() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤ç´¢å¼•å—ï¼Ÿ')) return;

            const btn = document.getElementById('btnDelete');
            const result = document.getElementById('indexResult');
            
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/category/index`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    result.innerHTML = '<pre class="success">âœ… ' + data.message + '</pre>';
                } else {
                    result.innerHTML = '<pre class="error">âŒ ' + data.error + '</pre>';
                }
            } catch (e) {
                result.innerHTML = '<pre class="error">âŒ è¯·æ±‚å¤±è´¥: ' + e.message + '</pre>';
            }

            btn.disabled = false;
            checkHealth();
        }

        // æŸ¥è¯¢ç±»ç›®
        async function queryCategory() {
            const text = document.getElementById('queryText').value.trim();
            const k = parseInt(document.getElementById('queryK').value) || 5;
            const btn = document.getElementById('btnQuery');
            const result = document.getElementById('queryResult');

            if (!text) {
                result.innerHTML = '<pre class="error">âŒ è¯·è¾“å…¥å•†å“æ–‡æœ¬</pre>';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>æŸ¥è¯¢ä¸­...';
            result.innerHTML = '<pre class="info">æ­£åœ¨æŸ¥è¯¢...</pre>';

            try {
                const res = await fetch(`${API_BASE}/category/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, k })
                });
                const data = await res.json();

                if (data.success && data.topK) {
                    let html = '';
                    data.topK.forEach((item, idx) => {
                        const score = (item.score * 100).toFixed(1);
                        html += `<div class="result-item">
                            <span class="score">#${idx + 1} ${score}%</span>
                            <span class="id">${item.id}</span>
                        </div>`;
                    });
                    result.innerHTML = html || '<pre class="info">æ— åŒ¹é…ç»“æœ</pre>';
                } else {
                    result.innerHTML = '<pre class="error">âŒ ' + (data.error || 'æŸ¥è¯¢å¤±è´¥') + '</pre>';
                }
            } catch (e) {
                result.innerHTML = '<pre class="error">âŒ è¯·æ±‚å¤±è´¥: ' + e.message + '</pre>';
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ æŸ¥è¯¢ç±»ç›®';
        }

        // å¿«é€Ÿæµ‹è¯•
        function quickTest(text) {
            document.getElementById('queryText').value = text;
            queryCategory();
        }
    </script>
</body>
</html>
