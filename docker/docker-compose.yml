version: '3.8'

services:
  product-taxonomy-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: product-taxonomy-api
    ports:
      - "6006:6006"
    env_file:
      # 从项目根目录读取 .env 文件
      - ../.env
    environment:
      # Embedding API 配置（支持从 .env 文件或环境变量读取）
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL:-https://api.siliconflow.cn/v1}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-BAAI/bge-m3}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-1024}

      # 服务器配置
      - PORT=${PORT:-6006}

      # Node.js 环境配置
      - NODE_ENV=production
    volumes:
      # 挂载数据目录（支持热更新类目数据）
      - ../data:/app/data:ro
      - ../vectors:/app/vectors:ro
      # 挂载日志目录（可选）
      - ../logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:6006/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - product-taxonomy-network
    # 生产环境资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  product-taxonomy-network:
    driver: bridge
